# RL-MAGE: Strengthening Malware Detectors against Smart Adversaries
Python implementation of RL-MAGE framework to strengthen machine learning based malware detectors against smart adversaries using reinforcement learning.

## Dataset
The dataset used for the experiments contains 5721 benign applications downloaded from the [Google Play Store](https://play.google.com/store/) and screened using [VirusTotal](https://www.virustotal.com/gui/home/upload). The dataset also contains 5553 malicious applications from the [Drebin](https://www.ndss-symposium.org/ndss2014/programme/drebin-effective-and-explainable-detection-android-malware-your-pocket/) dataset.

## Feature Extraction
We use the reverse engineering tool [Apktool](https://ibotpeaches.github.io/Apktool/) to develop a parser that extracts Android permission and Android intent usage in each Android application. This parser recorded 195 permissions and 273 intents to create two feature vectors (android permission and android intent) for each application.

## Notebooks
- TrainMalwareDetectionModels.ipynb - This is used to train malware detection machine learning models. The file has two training modes, one to train baseline models and the other to train the ARShield models. The trained models are saved along with their performance metrics.
- GenerateFeatureEnsemble.ipynb - This notebook explores various methods to generate ensemble of features. These features make up the action space for the Malware Evasion Attack (MEA) reinforcement learning agent.
- TrainReinforcementLearningAgents.ipynb - This notebook is used to train the reinforcement learning based Malware Evasion Attack (MEA) agent. This includes fetching malware classifiers to attack, creating environment for MEA agent, training the MEA agent, and finally, using the MEA agent to attack the malware classifiers. This file has two attack modes, one is to attack baseline models and the other is to attack the adversarially superior ARShield models. The notebook also generates plots, performs analysis on the results, and saves these in Google Drive.
- GenerateFoolingRateAndAccuracyDataPlots.ipynb - This is a helper notebook to generate data, analyze data and generate plots related to fooling rate and accuracy of the malware detection models over the course of RL-MAGE attack.
- GeneratePerturbationDataPlots.ipynb - This is a helper notebook to generate data, analyze data and generate plots related to the perturbations made by the MEA agent over the course of RL-MAGE attack to fool the malware detection models.

## Usage
1. Copy the training dataset to Google Drive in directory `gdrive/MyDrive/MalwareProject_v2/Dataset/Drebin/`
2. Upload the `.ipynb` files in Google Colab.
3. Execute the notebooks in order:
    1. TrainMalwareDetectionModels.ipynb
    2. GenerateFeatureEnsemble.ipynb
    3. TrainReinforcementLearningAgents.ipynb
    4. GenerateFoolingRateAndAccuracyDataPlots.ipynb
    5. GeneratePerturbationDataPlots.ipynb
